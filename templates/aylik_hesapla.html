{% extends 'base.html' %}
{% load static %}

{% block title %}Aylƒ±k Bordro Hesaplama{% endblock %}

{% block content %}
<div class="calculation-page">
    <div class="steps-navbar">
        <div class="navbar-container">
            <button class="nav-step active" onclick="showStep(1)" data-step="1">Temel √úcret</button>
            <button class="nav-step" onclick="showStep(2)" data-step="2">√áalƒ±≈üma Bilgileri</button>
            <button class="nav-step" onclick="showStep(3)" data-step="3">Sosyal G√ºvenlik</button>
            <button class="nav-step" onclick="showStep(4)" data-step="4">√ñzel Sigortalar</button>
            <button class="nav-step" onclick="showStep(5)" data-step="5">Fazla Mesailer</button>
        </div>
    </div>
    <div id="backend-data" style="display: none;"
         data-aylar="{{ aylar_json|escapejs }}">
    </div>

    {% if success %}
    <div style="max-width: 1200px; margin: 0 auto 1.5rem auto; padding: 0 2rem;">
        <div style="background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem;">
            <strong>‚úì {{ message }}</strong>
        </div>
    </div>
    {% endif %}

    {% if sonuc %}
    <div style="max-width: 1200px; margin: 0 auto 1.5rem auto; padding: 0 2rem;">
        <div class="result-display">
            <h3 style="color: #0891b2; margin-bottom: 1rem; font-size: 1.3rem;">üìä Bordro Hesaplama Sonu√ßlarƒ±</h3>

            <div class="result-section">
                <h4>üìÖ D√∂nem Bilgisi</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="result-label">Ay:</span>
                        <span class="result-value">{{ sonuc.donem.ay_adi.ad }} {{ sonuc.donem.yil }}</span>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h4>üí∞ Br√ºt Kazan√ßlar</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="result-label">Temel √úcret:</span>
                        <span class="result-value">{{ sonuc.brut_kazanclar.temel_ucret|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Fazla Mesai:</span>
                        <span class="result-value">{{ sonuc.brut_kazanclar.fazla_mesai|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Prime Tabi Br√ºt:</span>
                        <span class="result-value">{{ sonuc.brut_kazanclar.prime_tabi_brut|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item highlight">
                        <span class="result-label"><strong>Toplam Br√ºt:</strong></span>
                        <span class="result-value"><strong>{{ sonuc.brut_kazanclar.toplam_brut|floatformat:2 }} ‚Ç∫</strong></span>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h4>üè• SGK Bilgileri</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="result-label">SGK Matrahƒ±:</span>
                        <span class="result-value">{{ sonuc.sgk.matrah|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ƒ∞≈ü√ßi SGK:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.isci_sgk|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ƒ∞≈ü√ßi ƒ∞≈üsizlik:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.isci_issizlik|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BES:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.isci_bes|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ƒ∞≈üveren SGK:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.isveren_sgk|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ƒ∞≈üveren ƒ∞≈üsizlik:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.isveren_issizlik|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Hazine Yardƒ±mƒ±:</span>
                        <span class="result-value">{{ sonuc.sgk.primler.hazine_yardimi|floatformat:2 }} ‚Ç∫</span>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h4>üìã Vergiler</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="result-label">Gelir Vergisi Matrahƒ±:</span>
                        <span class="result-value">{{ sonuc.gelir_vergisi.matrah|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Hesaplanan GV:</span>
                        <span class="result-value">{{ sonuc.gelir_vergisi.hesaplanan|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">√ñdenecek GV:</span>
                        <span class="result-value">{{ sonuc.gelir_vergisi.odenecek|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Damga Vergisi:</span>
                        <span class="result-value">{{ sonuc.damga_vergisi.odenecek_dv|floatformat:2 }} ‚Ç∫</span>
                    </div>
                </div>
            </div>

            <div class="result-section" style="background: #dbeafe; border: 2px solid #3b82f6;">
                <h4 style="color: #1e40af;">üíµ Net √úcret</h4>
                <div class="result-grid">
                    <div class="result-item highlight">
                        <span class="result-label"><strong>NET √úCRET:</strong></span>
                        <span class="result-value" style="font-size: 1.5rem; color: #1e40af;"><strong>{{ sonuc.net_ucret|floatformat:2 }} ‚Ç∫</strong></span>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h4>üè¢ ƒ∞≈üveren Maliyeti</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <span class="result-label">Br√ºt √úcret:</span>
                        <span class="result-value">{{ sonuc.isveren_maliyeti.brut_ucret|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ƒ∞≈üveren SGK:</span>
                        <span class="result-value">{{ sonuc.isveren_maliyeti.isveren_sgk|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Te≈üvik:</span>
                        <span class="result-value">-{{ sonuc.isveren_maliyeti.tesvik_tutari|floatformat:2 }} ‚Ç∫</span>
                    </div>
                    <div class="result-item highlight">
                        <span class="result-label"><strong>Toplam Maliyet:</strong></span>
                        <span class="result-value"><strong>{{ sonuc.isveren_maliyeti.toplam_maliyet|floatformat:2 }} ‚Ç∫</strong></span>
                    </div>
                </div>
            </div>

            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #64748b; font-size: 0.9rem;">üîç Detaylƒ± Sonu√ß (JSON)</summary>
                <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.8rem; margin-top: 0.5rem;">{{ sonuc|pprint }}</pre>
            </details>
        </div>
    </div>
    {% endif %}


    {% if error %}
    <div style="max-width: 1200px; margin: 0 auto 1.5rem auto; padding: 0 2rem;">
        <div style="background: #ef4444; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem;">
            <strong>‚úó {{ message }}</strong>
            {% if traceback %}
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer;">Detaylarƒ± G√∂ster</summary>
                <pre style="background: rgba(0,0,0,0.2); padding: 1rem; margin-top: 0.5rem; overflow-x: auto; font-size: 0.8rem;">{{ traceback }}</pre>
            </details>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="calculation-container-new">

        <div class="form-content">

            <form class="modern-form" method="POST" action="{% url 'aylik_hesapla' %}">
                {% csrf_token %}
                <input type="hidden" name="bordro_yil" value="2026">

                <div class="step-content active" id="step1">
                    <div class="form-header-bar">
                        <h2>Temel √úcret</h2>
                        <div class="header-right">
                            <select class="action-select">
                                <option>-</option>
                            </select>
                            <div class="action-buttons">
                                <button type="button" class="icon-btn green" title="Yeni"><i class="fas fa-plus"></i></button>
                                <button type="button" class="icon-btn blue" title="Kaydet"><i class="fas fa-save"></i></button>
                                <button type="button" class="icon-btn yellow" title="D√ºzenle"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn red" title="Sil"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-content">

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Bordro Ayƒ±</label>
                                <select class="form-control" name="bordro_ay">
                                    <option value="1">Ocak</option>
                                    <option value="2">≈ûubat</option>
                                    <option value="3">Mart</option>
                                    <option value="4">Nisan</option>
                                    <option value="5">Mayƒ±s</option>
                                    <option value="6">Haziran</option>
                                    <option value="7">Temmuz</option>
                                    <option value="8">Aƒüustos</option>
                                    <option value="9">Eyl√ºl</option>
                                    <option value="10">Ekim</option>
                                    <option value="11">Kasƒ±m</option>
                                    <option value="12">Aralƒ±k</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Aylƒ±k Temel √úcret</label>
                                <input type="text" class="form-control" name="aylik_temel_ucret" value="33.030,00 ‚Ç∫">
                            </div>
                            <div class="form-group inline">
                                <label>Yƒ±llƒ±k G.V. Matrahƒ±</label>
                                <input type="text" class="form-control" name="yillik_gv_matrahi" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Tipi</label>
                                <select class="form-control" name="ucret_tipi">
                                    <option value="brut" selected>Br√ºt</option>
                                    <option value="net">Net</option>
                                </select>
                            </div>
                            <div class="form-group inline">
                                <label>Yƒ±llƒ±k Asg. √úcret G.V. Matrahƒ±</label>
                                <input type="text" class="form-control" name="yillik_asg_ucret_gv_matrahi" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>Gelir Vergisi</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" name="gelir_vergisi" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">Hesaplansƒ±n</span>
                                </label>
                            </div>
                            <div class="form-group inline">
                                <label>Damga Vergisi</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" name="damga_vergisi" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">Hesaplansƒ±n</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>Engellilik</label>
                                <select class="form-control" name="engellilik_durumu">
                                    <option value="normal" selected>Normal</option>
                                    <option value="1_derece">1. Derece</option>
                                    <option value="2_derece">2. Derece</option>
                                    <option value="3_derece">3. Derece</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Bordro Hesapla
                            </button>
                            <button type="button" class="btn-next" onclick="showStep(2)">
                                Sonraki Adƒ±m <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step2">
                    <div class="form-header-bar">
                        <h2>√áalƒ±≈üma Bilgileri</h2>
                        <div class="header-right">
                            <select class="action-select">
                                <option>-</option>
                            </select>
                            <div class="action-buttons">
                                <button type="button" class="icon-btn green"><i class="fas fa-plus"></i></button>
                                <button type="button" class="icon-btn blue"><i class="fas fa-save"></i></button>
                                <button type="button" class="icon-btn yellow"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn red"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-content">

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Bir Ay</label>
                                <select class="form-control" name="gun_sayisi_tipi">
                                    <option value="takvim" selected>Takvim G√ºn√º</option>
                                    <option value="30">30 G√ºn</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>√áalƒ±≈üƒ±lan G√ºn</label>
                                <input type="text" class="form-control" name="calisilan_gun" value="30">
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>Eksik Saat</label>
                                <input type="text" class="form-control" name="eksik_saat" value="0,00">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-prev" onclick="showStep(1)">
                                <i class="fas fa-arrow-left"></i> √ñnceki Adƒ±m
                            </button>
                            <button type="submit" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Bordro Hesapla
                            </button>
                            <button type="button" class="btn-next" onclick="showStep(3)">
                                Sonraki Adƒ±m <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step3">
                    <div class="form-header-bar">
                        <h2>Sosyal G√ºvenlik</h2>
                        <div class="header-right">
                            <select class="action-select">
                                <option>-</option>
                            </select>
                            <div class="action-buttons">
                                <button type="button" class="icon-btn green"><i class="fas fa-plus"></i></button>
                                <button type="button" class="icon-btn blue"><i class="fas fa-save"></i></button>
                                <button type="button" class="icon-btn yellow"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn red"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-content">

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Sosyal G√ºvenlik Tipi</label>
                                <select class="form-control" name="sgk_tipi">
                                    <option value="01" selected>01-Hizmet Akdi ile T√ºm Sigorta Kollarƒ±na Tabi √áalƒ±≈üanlar</option>
                                    {% for kod, data in sgk_tipleri.items %}
                                    <option value="{{ kod }}">{{ kod }}-{{ data.ad }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Kanun No</label>
                                <select class="form-control" name="kanun_no">
                                    {% for kod, kanun in sgk_kanunlari.items %}
                                    <option value="{{ kod }}" {% if kod == '00000' %}selected{% endif %}>{{ kod }}-{{ kanun.ad }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Hazine Yardƒ±mƒ±</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" name="hazine_yardimi" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">Hesaplansƒ±n</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>B.E.S.</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" name="bes" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">Hesaplansƒ±n</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Devir Matrah (2 √∂nceki ay)</label>
                                <input type="text" class="form-control" name="devir_matrah_2ay" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>Devir Matrah (1 √∂nceki ay)</label>
                                <input type="text" class="form-control" name="devir_matrah_1ay" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-prev" onclick="showStep(2)">
                                <i class="fas fa-arrow-left"></i> √ñnceki Adƒ±m
                            </button>
                            <button type="submit" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Bordro Hesapla
                            </button>
                            <button type="button" class="btn-next" onclick="showStep(4)">
                                Sonraki Adƒ±m <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="step-content" id="step4">
                    <div class="form-header-bar">
                        <h2>√ñzel Sigortalar</h2>
                        <div class="header-right">
                            <select class="action-select">
                                <option>-</option>
                            </select>
                            <div class="action-buttons">
                                <button type="button" class="icon-btn green"><i class="fas fa-plus"></i></button>
                                <button type="button" class="icon-btn blue"><i class="fas fa-save"></i></button>
                                <button type="button" class="icon-btn yellow"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn red"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-content">
                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Saƒülƒ±k Sigortasƒ± ƒ∞≈ü√ßi</label>
                                <input type="text" class="form-control" name="saglik_sig_isci" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Saƒülƒ±k Sigortasƒ± ƒ∞≈üveren</label>
                                <input type="text" class="form-control" name="saglik_sig_isveren" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>Hayat Sigortasƒ± ƒ∞≈ü√ßi</label>
                                <input type="text" class="form-control" name="hayat_sig_isci" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>Hayat Sigortasƒ± ƒ∞≈üveren</label>
                                <input type="text" class="form-control" name="hayat_sig_isveren" value="0,00 ‚Ç∫">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-prev" onclick="showStep(3)">
                                <i class="fas fa-arrow-left"></i> √ñnceki Adƒ±m
                            </button>
                            <button type="submit" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Bordro Hesapla
                            </button>
                            <button type="button" class="btn-next" onclick="showStep(5)">
                                Sonraki Adƒ±m <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="step5">
                    <div class="form-header-bar">
                        <h2>Fazla Mesailer</h2>
                        <div class="header-right">
                            <select class="action-select">
                                <option>-</option>
                            </select>
                            <div class="action-buttons">
                                <button type="button" class="icon-btn green"><i class="fas fa-plus"></i></button>
                                <button type="button" class="icon-btn blue"><i class="fas fa-save"></i></button>
                                <button type="button" class="icon-btn yellow"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn red"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-content">

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>FM01 (50,00 %)</label>
                                <input type="text" class="form-control" name="fm01_saat" value="0,00 saat">
                            </div>
                        </div>

                        <div class="form-row-inline separator">
                            <div class="form-group inline">
                                <label>FM02 (100,00 %)</label>
                                <input type="text" class="form-control" name="fm02_saat" value="0,00 saat">
                            </div>
                        </div>

                        <div class="form-row-inline">
                            <div class="form-group inline">
                                <label>FM03 (200,00 %)</label>
                                <input type="text" class="form-control" name="fm03_saat" value="0,00 saat">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-prev" onclick="showStep(4)">
                                <i class="fas fa-arrow-left"></i> √ñnceki Adƒ±m
                            </button>
                            <button type="submit" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Bordro Hesapla
                            </button>
                        </div>
                    </div>
                </div>

            </form>


        </div>
    </div>
</div>

<script>

function showStep(stepNumber) {
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });

    document.querySelectorAll('.nav-step').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById('step' + stepNumber).classList.add('active');
    document.querySelector('.nav-step[data-step="' + stepNumber + '"]').classList.add('active');

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', function() {
    const backendData = document.getElementById('backend-data');
    let ayGunleri = {};

    try {
        const aylarData = JSON.parse(backendData.dataset.aylar);
        for (const [ayNo, ayData] of Object.entries(aylarData)) {
            ayGunleri[parseInt(ayNo)] = parseInt(ayData.gun);
        }

        console.log('Ay g√ºnleri y√ºklendi:', ayGunleri);
    } catch (error) {
        console.error(' AYLAR verisi y√ºklenemedi:', error);
        // Fallback - Hard-coded deƒüerler
        ayGunleri = {
            1: 31, 2: 28, 3: 31, 4: 30, 5: 31, 6: 30,
            7: 31, 8: 31, 9: 30, 10: 31, 11: 30, 12: 31
        };
    }

    const aySelect = document.querySelector('select[name="bordro_ay"]');
    const calisanGunInput = document.querySelector('input[name="calisilan_gun"]');
    const gunSayisiTipiSelect = document.querySelector('select[name="gun_sayisi_tipi"]');

    if (aySelect) {
        aySelect.addEventListener('change', function() {
            updateCalisanGun();
        });
    }

    if (gunSayisiTipiSelect) {
        gunSayisiTipiSelect.addEventListener('change', function() {
            updateCalisanGun();
        });
    }

    function updateCalisanGun() {
        if (!aySelect || !calisanGunInput || !gunSayisiTipiSelect) return;

        const secilenAy = parseInt(aySelect.value);
        const gunTipi = gunSayisiTipiSelect.value;

        if (gunTipi === 'takvim') {
            calisanGunInput.value = ayGunleri[secilenAy] || 30;
        } else if (gunTipi === '30') {
            calisanGunInput.value = 30;
        }
    }
});
</script>
{% endblock %}
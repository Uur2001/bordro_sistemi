{% extends 'base.html' %}
{% load static %}

{% block title %}Kƒ±dem ve ƒ∞hbar Tazminatƒ± Hesaplama{% endblock %}

{% block content %}
<div class="tazminat-page">
    <div class="action-bar">
        <select class="action-select">
            <option>-</option>
        </select>
        <button class="action-btn green"><i class="fas fa-plus"></i></button>
        <button class="action-btn blue"><i class="fas fa-save"></i></button>
        <button class="action-btn cyan"><i class="fas fa-edit"></i></button>
        <button class="action-btn red"><i class="fas fa-trash"></i></button>
        <button class="action-btn-large green" id="btn-hesapla"><i class="fas fa-calculator"></i> Hesapla</button>
        <button class="action-btn-large red"><i class="fas fa-file-pdf"></i> PDF Bordro</button>
    </div>

    <div class="tazminat-container">
        <div class="left-panel">
            <!-- 1. KART: Tazminata Esas S√ºre -->
            <div class="info-card">
                <h3 class="card-title">Tazminata Esas S√ºre</h3>
                <div class="card-content">
                    <div class="form-row">
                        <label>Giri≈ü Tarihi</label>
                        <input type="date" class="form-control" id="giris_tarihi" value="2020-01-15">
                    </div>
                    <div class="form-row">
                        <label>√áƒ±kƒ±≈ü Tarihi</label>
                        <input type="date" class="form-control" id="cikis_tarihi" value="2026-02-04">
                    </div>
                    <div class="form-row">
                        <label>Kƒ±dem Dƒ±≈üƒ± S√ºre</label>
                        <input type="text" class="form-control" id="kidem_disi_gun" value="0">
                    </div>
                </div>
            </div>

            <!-- 2. KART: Tazminata Esas √úcretler -->
            <div class="info-card">
                <h3 class="card-title">Tazminata Esas √úcretler</h3>
                <div class="card-content">
                    <div class="three-col-row">
                        <div class="col-item">
                            <label>Aylƒ±k Br√ºt √úcret</label>
                            <input type="text" class="form-control" id="aylik_brut_ucret" value="33.030,00 ‚Ç∫">
                        </div>
                        <div class="col-item">
                            <label>Aylƒ±k Br√ºt Ek √úcr.</label>
                            <input type="text" class="form-control" id="aylik_brut_ek_ucret" value="0,00 ‚Ç∫">
                        </div>
                        <div class="col-item">
                            <label>Yƒ±llƒ±k Br√ºt ƒ∞kramiye</label>
                            <input type="text" class="form-control" id="yillik_brut_ikramiye" value="0,00 ‚Ç∫">
                        </div>
                    </div>
                    <div class="three-col-row">
                        <div class="col-item">
                            <label>Yƒ±llƒ±k G.V. Matrahƒ±</label>
                            <input type="text" class="form-control" id="kumulatif_gv_matrahi" value="0,00 ‚Ç∫">
                        </div>
                        <div class="col-item">
                            <label>Aylƒ±k Giy. Br√ºt √úcr.</label>
                            <input type="text" class="form-control" id="giydirilmis_brut" value="33.030,00 ‚Ç∫" readonly style="background:#f0f0f0;">
                        </div>
                        <div class="col-item">
                            <label>Kƒ±dem Tazm.Tavanƒ±</label>
                            <input type="text" class="form-control" id="kidem_tavani" value="64.948,77 ‚Ç∫" readonly style="background:#f0f0f0;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. KART: Hesaplama Parametreleri -->
            <div class="info-card">
                <h3 class="card-title">Hesaplama Parametreleri</h3>
                <div class="card-content">
                    <div class="param-row">
                        <label>ƒ∞hbar Tazminatƒ±</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ihbar_hesaplansin" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Hesaplansƒ±n</span>
                        </label>
                    </div>
                    <div class="param-row">
                        <label>ƒ∞hbar Tazminatƒ± Gelir Vergisi</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ihbar_gv_hesaplansin" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Hesaplansƒ±n</span>
                        </label>
                    </div>
                    <div class="param-row">
                        <label>ƒ∞hbar Tazminatƒ± Damga Vergisi</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ihbar_dv_hesaplansin" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Hesaplansƒ±n</span>
                        </label>
                    </div>
                    <div class="param-row">
                        <label>Kƒ±dem Tazminatƒ± Damga Vergisi</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="kidem_dv_hesaplansin" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Hesaplansƒ±n</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- JSON Sonu√ß (Debug) -->
            <div id="json-card" style="display:none; margin-top: 1rem;">
                <details>
                    <summary style="cursor: pointer; color: #64748b; font-size: 0.9rem;">üîç Detaylƒ± Sonu√ß (JSON)</summary>
                    <pre id="json-sonuc" style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.8rem; margin-top: 0.5rem; max-height: 400px; overflow-y: auto;"></pre>
                </details>
            <div id="excel-buton-alani" style="margin-top: 1.5rem; text-align: center; display: none;">
                    <a href="#" id="btn-tazminat-excel" class="btn-export-excel">
                        <i class="fas fa-file-excel"></i> Excel ƒ∞ndir
                    </a>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="result-card" id="hizmet-card">
                <h3 class="result-title">Hizmet S√ºresi</h3>
                <div class="totals-content">
                    <div class="total-row">
                        <span>Net Hizmet S√ºresi</span>
                        <strong id="hizmet-suresi">- Yƒ±l, - Ay, - G√ºn</strong>
                    </div>
                </div>
            </div>
            <div class="result-card">
                <h3 class="result-title">Kƒ±d. Taz.</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Kƒ±d. Taz.</th>
                            <th>Adet</th>
                            <th>Bir.Tut.</th>
                            <th>Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Yƒ±l</td>
                            <td id="kidem-yil-adet">-</td>
                            <td id="kidem-yil-birim">-</td>
                            <td id="kidem-yil-tutar">-</td>
                        </tr>
                        <tr>
                            <td>Ay</td>
                            <td id="kidem-ay-adet">-</td>
                            <td id="kidem-ay-birim">-</td>
                            <td id="kidem-ay-tutar">-</td>
                        </tr>
                        <tr>
                            <td>G√ºn</td>
                            <td id="kidem-gun-adet">-</td>
                            <td id="kidem-gun-birim">-</td>
                            <td id="kidem-gun-tutar">-</td>
                        </tr>
                        <tr class="total-row-table">
                            <td><strong>Br√ºt Kƒ±dem Tazminatƒ±</strong></td>
                            <td></td>
                            <td></td>
                            <td><strong id="kidem-brut-toplam">-</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="result-card">
                <h3 class="result-title">ƒ∞hbar Taz.</h3>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>G√ºn</th>
                            <th>Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Aylƒ±k Giy. Br√ºt √úcr.</td>
                            <td>30</td>
                            <td id="ihbar-aylik-brut">-</td>
                        </tr>
                        <tr>
                            <td>G√ºnl√ºk Br√ºt √úcret</td>
                            <td>1</td>
                            <td id="ihbar-gunluk-brut">-</td>
                        </tr>
                        <tr>
                            <td>Br√ºt ƒ∞hbar Tazm.</td>
                            <td id="ihbar-gun-sayisi">-</td>
                            <td id="ihbar-brut-toplam">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="result-card">
                <h3 class="result-title">Toplamlar</h3>
                <div class="totals-content">
                    <div class="total-row">
                        <span>Br√ºt Tazminat Toplamƒ±</span>
                        <strong id="toplam-brut">-</strong>
                    </div>
                    <div class="total-row">
                        <span>Gelir Vergisi (-)</span>
                        <strong id="toplam-gv">-</strong>
                    </div>
                    <div class="total-row">
                        <span>Damga Vergisi (-)</span>
                        <strong id="toplam-dv">-</strong>
                    </div>
                    <div class="total-row final">
                        <span>Net Tazminat Toplamƒ±</span>
                        <strong id="toplam-net">-</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function parseTurkishNumber(value) {
    if (typeof value === 'number') return value;
    let s = String(value).trim();
    ['‚Ç∫', 'TL', 'g√ºn', 'saat', '%'].forEach(u => s = s.replace(u, ''));
    s = s.trim();
    if (!s) return 0;
    s = s.replace(/\./g, '').replace(',', '.');
    return parseFloat(s) || 0;
}

function formatPara(sayi) {
    if (sayi === null || sayi === undefined || sayi === '-') return '-';
    return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(sayi) + ' ‚Ç∫';
}

function collectFormData() {
    return {
        giris_tarihi: document.getElementById('giris_tarihi').value,
        cikis_tarihi: document.getElementById('cikis_tarihi').value,
        kidem_disi_gun: parseTurkishNumber(document.getElementById('kidem_disi_gun').value),
        aylik_brut_ucret: parseTurkishNumber(document.getElementById('aylik_brut_ucret').value),
        aylik_brut_ek_ucret: parseTurkishNumber(document.getElementById('aylik_brut_ek_ucret').value),
        yillik_brut_ikramiye: parseTurkishNumber(document.getElementById('yillik_brut_ikramiye').value),
        kumulatif_gv_matrahi: parseTurkishNumber(document.getElementById('kumulatif_gv_matrahi').value),
        ihbar_hesaplansin: document.getElementById('ihbar_hesaplansin').checked,
        ihbar_gv_hesaplansin: document.getElementById('ihbar_gv_hesaplansin').checked,
        ihbar_dv_hesaplansin: document.getElementById('ihbar_dv_hesaplansin').checked,
        kidem_dv_hesaplansin: document.getElementById('kidem_dv_hesaplansin').checked,
    };
}

async function hesaplaTazminat() {
    const btn = document.getElementById('btn-hesapla');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Hesaplanƒ±yor...';
    btn.disabled = true;

    try {
        const formData = collectFormData();
        const select = document.querySelector('.action-select');
        if (select && select.value) {
            formData.calisan_id = select.value;
        }

        console.log('G√∂nderilen veri:', formData);

        const response = await fetch('{% url "tazminat_hesapla_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        console.log('Sonu√ß:', result);

        if (result.success) {
            sonucGoster(result.sonuc, result.tazminat_id);
        }    else {
            alert('Hesaplama hatasƒ±: ' + (result.error || 'Bilinmeyen hata'));
            console.error('Hata detayƒ±:', result.traceback);
        }
    } catch (error) {
        console.error('Baƒülantƒ± hatasƒ±:', error);
        alert('Baƒülantƒ± hatasƒ±: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function sonucGoster(sonuc, tazminat_id) {
        document.getElementById('json-card').style.display = 'block';
        document.getElementById('json-sonuc').textContent = JSON.stringify(sonuc, null, 2);
        const excelButonAlani = document.getElementById('excel-buton-alani');
        const excelButon = document.getElementById('btn-tazminat-excel');
        if (excelButonAlani && excelButon && tazminat_id) {
            excelButon.href = `/api/export/tazminat/${tazminat_id}/excel/`;
            excelButonAlani.style.display = 'block';
    }

    const kidem = sonuc.kidem;
    if (kidem.hak_edildi) {
        document.getElementById('kidem-yil-adet').textContent = kidem.yil.adet;
        document.getElementById('kidem-yil-birim').textContent = formatPara(kidem.yil.birim_tutar);
        document.getElementById('kidem-yil-tutar').textContent = formatPara(kidem.yil.tutar);
        document.getElementById('kidem-ay-adet').textContent = kidem.ay.adet;
        document.getElementById('kidem-ay-birim').textContent = formatPara(kidem.ay.birim_tutar);
        document.getElementById('kidem-ay-tutar').textContent = formatPara(kidem.ay.tutar);
        document.getElementById('kidem-gun-adet').textContent = kidem.gun.adet;
        document.getElementById('kidem-gun-birim').textContent = formatPara(kidem.gun.birim_tutar);
        document.getElementById('kidem-gun-tutar').textContent = formatPara(kidem.gun.tutar);
        document.getElementById('kidem-brut-toplam').textContent = formatPara(kidem.brut_toplam);
    } else {
        document.getElementById('kidem-yil-adet').textContent = '-';
        document.getElementById('kidem-yil-birim').textContent = '-';
        document.getElementById('kidem-yil-tutar').textContent = '-';
        document.getElementById('kidem-ay-adet').textContent = '-';
        document.getElementById('kidem-ay-birim').textContent = '-';
        document.getElementById('kidem-ay-tutar').textContent = '-';
        document.getElementById('kidem-gun-adet').textContent = '-';
        document.getElementById('kidem-gun-birim').textContent = '-';
        document.getElementById('kidem-gun-tutar').textContent = '-';
        document.getElementById('kidem-brut-toplam').textContent = 'Hak Edilmedi (< 1 Yƒ±l)';
    }

    const ihbar = sonuc.ihbar;
    document.getElementById('ihbar-aylik-brut').textContent = formatPara(sonuc.ucretler.giydirilmis_brut);
    document.getElementById('ihbar-gunluk-brut').textContent = formatPara(ihbar.gunluk_brut);
    document.getElementById('ihbar-gun-sayisi').textContent = ihbar.sure_gun;
    document.getElementById('ihbar-brut-toplam').textContent = formatPara(ihbar.brut_toplam);

    const toplam = sonuc.toplam;
    document.getElementById('toplam-brut').textContent = formatPara(toplam.brut_tazminat);
    document.getElementById('toplam-gv').textContent = formatPara(toplam.gelir_vergisi);
    document.getElementById('toplam-dv').textContent = formatPara(toplam.damga_vergisi);
    document.getElementById('toplam-net').textContent = formatPara(toplam.net_tazminat);

    document.getElementById('json-card').style.display = 'block';
    document.getElementById('json-sonuc').textContent = JSON.stringify(sonuc, null, 2);
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('btn-hesapla').addEventListener('click', hesaplaTazminat);
    console.log('Tazminat hesaplama JS y√ºklendi');
});
</script>
{% endblock %}